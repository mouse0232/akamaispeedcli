name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.19

    - name: Get tag name
      id: tag
      run: echo "::set-output name=version::${GITHUB_REF#refs/tags/}"

    - name: Build binaries and create archives
      run: |
        mkdir -p release
        platforms=("windows/amd64" "darwin/amd64" "darwin/arm64" "linux/amd64" "linux/arm64")
        for platform in "${platforms[@]}"; do
          os=$(echo $platform | cut -d'/' -f1)
          arch=$(echo $platform | cut -d'/' -f2)
          suffix=""
          if [ "$os" = "windows" ]; then
            suffix=".exe"
          fi
          export GOOS=$os
          export GOARCH=$arch
          binary_name="atlanta$suffix"
          go build -o "$binary_name" .
          
          # Create archive
          if [ "$os" = "windows" ]; then
            zip -j "release/atlanta-$os-$arch.zip" "$binary_name"
          else
            tar -czf "release/atlanta-$os-$arch.tar.gz" "$binary_name"
          fi
          
          # Clean up binary
          rm "$binary_name"
        done

    - name: Create release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: release/*
        draft: true
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}